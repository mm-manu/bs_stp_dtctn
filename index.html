<html lang="en">
  <head>
    <link rel="stylesheet" href="map/ol.css" type="text/css">
    <style>
		.map {
			height: 100%;
			width: 100%;
		}
		#popup {
			border: 1px solid white;
			border-radius: 4px;
			background-color: white;
		}
		th {text-align:left;}
		table {
			border-collapse: collapse;
		}
		table, th, td {
			border: 1px solid black;
		}
		#layer_selection_panel {
			position: absolute;
			top: 5px;
			right: 0;
			width: 200px;
			height: 100px;
			border: 3px solid rgba(148,146,151,0.7);
			border-radius: 4px;
			color: white;
			background-color: rgba(40,122,170,0.7);
		}
    </style>
    <script src="map/ol.js" type="text/javascript"></script>
    <title>Ally GIT Challenge</title>
  </head>
  <body bgcolor="black">
    <div id="map" class="map">
		<div id="popup"></div>
		<div id="layer_selection_panel">
			<input id="checkbox_routes" type="checkbox" name="show routes" value="Routes" onClick="select_layers(this)" checked />Routes<br/>
			<input id="checkbox_activity_points" type="checkbox" name="show activity points" onClick="select_layers(this)" checked />Activity points<br/>
			<input id="checkbox_filtered_points" type="checkbox" name="show filtered activity points" onClick="select_layers(this)" checked />Filtered activity points<br/>
			<input id="checkbox_osm_bus_stops" type="checkbox" name="show bus stops from OSM" onClick="select_layers(this)" checked />Bus stops from OSM<br/>
		</div>	
	</div>
    <script type="text/javascript">
	var styles = {
		osm_bus_stop_style: new ol.style.Style({
			image: new ol.style.Icon({
				src: 'map/bus_stop.png',
				scale: 0.08
				})
			})
	};
	
	var routes = new ol.layer.Vector({
		source: new ol.source.Vector({
			url: 'data/routes.geojson',
			format: new ol.format.GeoJSON({
				projection: 'EPSG:3857'
			})
		}) 
	});
	
	var activity_points = new ol.layer.Vector({
		source: new ol.source.Vector({
			url: 'data/activity_points.geojson',
			format: new ol.format.GeoJSON({
				projection: 'EPSG:3857'
			})
		}) 
	});

	var filtered_points = new ol.layer.Vector({
		source: new ol.source.Vector({
			url: 'data/filtered_activity_points.geojson',
			format: new ol.format.GeoJSON({
				projection: 'EPSG:3857'
			})
		}) 
	});
	
	var osm_bus_stops = new ol.layer.Vector({
		source: new ol.source.Vector({
			url: 'data/osm_bus_stops.geojson',
			format: new ol.format.GeoJSON({
				projection: 'EPSG:3857'
			})
		}),
		style: styles['osm_bus_stop_style']
	});
	
		
			
	var map = new ol.Map({
		target: 'map',
		layers: [
				new ol.layer.Tile({
					source: new ol.source.OSM(),
					opacity: 0.2
				}),
				routes,
				activity_points,
				filtered_points,
				osm_bus_stops
				],
		view: new ol.View({
			center: ol.proj.transform([39.2702,-6.822517], 'EPSG:4326', 'EPSG:3857'),
			zoom: 12
		})
	});
	
	var layer_selection_container = document.getElementById('layer_selection_panel');
	var layer_control = new ol.control.Control({
		element: layer_selection_container
	});
	map.addControl(layer_control);
	
	var select_layers = function(caller){
		switch(caller.id){
			case 'checkbox_routes':
				routes.setVisible(caller.checked);
				break;
			case 'checkbox_activity_points':
				activity_points.setVisible(caller.checked);
				break;
			case 'checkbox_filtered_points':
				filtered_points.setVisible(caller.checked);
				break;
			case 'checkbox_osm_bus_stops':
				osm_bus_stops.setVisible(caller.checked);
				break;
		}
	};
	
	var popup_container = document.getElementById('popup');	
	var popup = new ol.Overlay({
		element: popup_container
	});
	map.addOverlay(popup);
	
	
	var show_feature_info = function(pixel, coordinate) {
		var activity_point_features = [];
		var filtered_point_features = [];
		var route_features = [];
		var osm_bus_stop_features = [];
		
		map.forEachFeatureAtPixel(pixel, function(feature, layer) {
			if(layer==filtered_points){
				filtered_point_features.push(feature);
			} else if (layer==routes){
				route_features.push(feature);
			} else if (layer==activity_points){
				activity_point_features.push(feature);
			} else if (layer==osm_bus_stops){
				osm_bus_stop_features.push(feature);
			}
        });
		
		var popupHTML = '';
		if (activity_point_features.length > 0) {
			activity_point_features.sort();
			popupHTML = 'Activity point(s):<br/><table><tr>'+
						'<th>id</th><th>previous activity (confidence)</th>'+
						'<th>current activity (confidence)</th><th>speed</th></tr>';
			for (var i = 0; i < activity_point_features.length; ++i) {
				popupHTML = popupHTML+'<tr><td>'+activity_point_features[i].get('id')+'</td>'+
							'<td>'+activity_point_features[i].get('previous_dominating_activity')+
							  ' ('+activity_point_features[i].get('previous_dominating_activity_confidence')+')</td>'+
							'<td>'+activity_point_features[i].get('current_dominating_activity')+
							  ' ('+activity_point_features[i].get('current_dominating_activity_confidence')+')</td>'+
							'<td>'+activity_point_features[i].get('speed')+'</td></tr>';
			}
			popupHTML = popupHTML+'</table>';
		}
		if (filtered_point_features.length > 0){
			filtered_point_features.sort();
			popupHTML = 'Filtered activity point(s):<br/><table><tr>'+
						'<th>id</th><th>previous activity (confidence)</th>'+
						'<th>current activity (confidence)</th><th>speed</th></tr>';
			for (var i = 0; i < filtered_point_features.length; ++i) {
				popupHTML = popupHTML+'<tr><td>'+filtered_point_features[i].get('id')+'</td>'+
							'<td>'+filtered_point_features[i].get('previous_dominating_activity')+
							  ' ('+filtered_point_features[i].get('previous_dominating_activity_confidence')+')</td>'+
							'<td>'+filtered_point_features[i].get('current_dominating_activity')+
							  ' ('+filtered_point_features[i].get('current_dominating_activity_confidence')+')</td>'+
							'<td>'+filtered_point_features[i].get('speed')+'</td></tr>';
			}
			popupHTML = popupHTML+'</table>';
		}
		if (osm_bus_stop_features.length > 0){
			osm_bus_stop_features.sort();
			popupHTML = 'OSM bus stop(s):<br/><table><tr><th>name</th></tr>';
			for (var i = 0; i < osm_bus_stop_features.length; ++i) {
				popupHTML = popupHTML+'<tr><td>'+osm_bus_stop_features[i].get('name')+'</td></tr>';
			}
			popupHTML = popupHTML+'</table>';
		}
		if (route_features.length > 0){
			route_features.sort()
			popupHTML = popupHTML+'Route(s):<br/><table><tr><th>route_id</th></tr>';
			for (var i = 0; i < route_features.length; ++i) {
				popupHTML = popupHTML+'<tr><td>'+route_features[i].get('route_id')+'</td></tr>';
			}
			popupHTML = popupHTML+'</table>';
		}

		popupHTML.length>0 ? popup_container.style.border='1px solid white' : popup_container.style.border='0px';
		popup_container.innerHTML =  popupHTML; 
        popup.setPositioning('top-left');
		popup.setPosition(coordinate);
		
	};
	
	map.on('click', function(evt) {
		show_feature_info(evt.pixel, evt.coordinate);
	});
    </script>
  </body>
</html>