<html lang="en">
  <head>
    <link rel="stylesheet" href="ol.css" type="text/css">
    <style>
		.map {
			height: 100%;
			width: 100%;
		}
		#popup {
			border: 1px solid white;
			border-radius: 5px;
			background-color: white;
		}
		th {text-align:left;}
		table {
			border-collapse: collapse;
		}
		table, th, td {
			border: 1px solid black;
		}
    </style>
    <script src="ol.js" type="text/javascript"></script>
    <title>Ally GIT Challenge</title>
  </head>
  <body bgcolor="black">
    <div id="map" class="map">
		<div id="popup"></div>
	</div>
    <script type="text/javascript">
	var routes = new ol.layer.Vector({
										source: new ol.source.GeoJSON({
											url: '../data/routes.geojson',
											projection: 'EPSG:3857'
										}) 
									});
	var actPts = new ol.layer.Vector({
										source: new ol.source.GeoJSON({
											url: '../data/activity_points.geojson',
											projection: 'EPSG:3857'
										}) 
									});
	var filteredPts = new ol.layer.Vector({
											source: new ol.source.GeoJSON({
												url: '../stops.geojson',
												projection: 'EPSG:3857'
											}) 
										  });									
			
	var map = new ol.Map({
						target: 'map',
						layers: [
							new ol.layer.Tile({
								source: new ol.source.OSM(),
								opacity: 0.2
								}), 
								routes,
								filteredPts
								],
							view: new ol.View({
								center: ol.proj.transform([39.2702,-6.822517], 'EPSG:4326', 'EPSG:3857'),
								zoom: 12
								})
							});
							
	var popup = new ol.Overlay({
        element: document.getElementById('popup')
      });
	map.addOverlay(popup);
	
	var container = document.getElementById('popup');
	var showFeatureInfo = function(pixel, coordinate) {
		var pointFeatures = [];
		var routeFeatures = [];
		map.forEachFeatureAtPixel(pixel, function(feature, layer) {
			if(layer==filteredPts){
				pointFeatures.push(feature);
			} else if (layer==routes){
				routeFeatures.push(feature)
			}
        });
		var popupHTML = ''
		if (pointFeatures.length > 0) {
			pointFeatures.sort();
			popupHTML = 'Activity point(s):<br/><table><tr><th>id</th><th>pda</th><th>pda_conf</th><th>cda</th><th>cda_conf</th><th>speed</th></tr>'
			for (var i = 0; i < pointFeatures.length; ++i) {
				popupHTML = popupHTML+'<tr><td>'+pointFeatures[i].get('id')+'</td><td>'+pointFeatures[i].get('previous_dominating_activity')+'</td>'+
							'<td>'+pointFeatures[i].get('previous_dominating_activity_confidence')+'</td><td>'+pointFeatures[i].get('current_dominating_activity')+'</td>'+
							'<td>'+pointFeatures[i].get('current_dominating_activity_confidence')+'</td><td>'+pointFeatures[i].get('speed')+'</td></tr>'
			}
			popupHTML = popupHTML+'</table>'
		}
		if (routeFeatures.length > 0){
			routeFeatures.sort()
			popupHTML = popupHTML+'Route(s):<br/><table><tr><th>route_id</th></tr>'
			for (var i = 0; i < routeFeatures.length; ++i) {
				popupHTML = popupHTML+'<tr><td>'+routeFeatures[i].get('route_id')+'</td></tr>'
			}
			popupHTML = popupHTML+'</table>'
		}
		popupHTML.length>0 ? container.style.border='1px solid white' : container.style.border='0px';
		container.innerHTML =  popupHTML 
        popup.setPositioning('top-left');
		popup.setPosition(coordinate);
		
	};
	map.on('click', function(evt) {
		var coordinate = evt.coordinate;
		showFeatureInfo(evt.pixel, coordinate);
	});
    </script>
  </body>
</html>